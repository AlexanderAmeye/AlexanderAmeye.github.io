<!DOCTYPE html>
<html>

<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-137365487-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-137365487-1');
    </script>

    <link rel="icon" type="image/png" href="assets/icon.png" sizes="32x32" />
    <title>Toon Shader</title>

    <meta charset="utf-8" />

    <meta property="og:title" content="Alexander Ameye" />
    <meta property="og:site_name" content="Alexander Ameye" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://alexanderameye.github.io/toon-shading/" />

    <meta name="description" content="" />
    <meta name="author" content="Alexander ameye" />

    <style type="text/css">

div {
width: auto;
  padding: 10px;
  border: 2px dotted blue;
  margin: 0;
  text-align: center;

}


        p.p1 {
            margin: 0.0px 0.0px 0.0px 0.0px;
            font: 13.0px Arial;
            text-align: justify;
        }

        p.p2 {
            margin: 0.0px 0.0px 0.0px 0.0px;
            font: 13.0px Arial;
            min-height: 14.0px;
            text-align: justify;
        }

        a:link {
            color: blue;
            text-decoration: none;
            font-weight: bold;
        }

        a:visited {
            color: blue;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        pre {
            font: 13.0px Courier;
            width: 800px;
            text-align: justify;
            position: relative;
            white-space: -moz-pre-wrap;
            /* Mozilla, supported since 1999 */
            white-space: -pre-wrap;
            /* Opera */
            white-space: -o-pre-wrap;
            /* Opera */
            white-space: pre-wrap;
            /* CSS3 - Text module (Candidate Recommendation) http://www.w3.org/TR/css3-text/#white-space */
            word-wrap: break-word;
            /* IE 5.5+ */
        }

        span.white {
            color: white;
        }

        p span.show {
            display: none;
        }

        p:hover span.show {
            display: inline;
        }

        p:hover span.noshow {
            display: none;
        }
    </style>

</head>

<body>
    <pre>
<h1>Toon Shading</h1><a href="../index.html">Back to projects</a>

<p1 style="color:#FF2222"><b>Important:</b></p1> This tutorial makes use of some custom function nodes to get lighting information. Shader graph is still in preview and this method will <b>most likely</b> break in future versions. I do some <i>hacky</i> stuff in this tutorial and in general this is not recommended.

<img src="assets/Ice-toon 2.gif">
<i>The final effect.</i>

<h1>Setup</h1>For this shader, we will be using a LWRP <b><i>Unlit shader</i></b>. I am using LWRP/Shadergraph version 5.10.0 in Unity 2019.1b. You also need a directional light in your scene.

<h1>What Is Toon Shading?</h1><div>Want to <a href="#tutorial-shortcut" style="color:blue">skip theory</a>?
</div>
In a toon shader the model gets divided into 3 regions. You have dark-tone areas (unlit), mid-tone areas (lit) and highlights. The model is shaded with a flat color. Toon shading is gets its look by not using a shading gradient but harder cut-offs. A toon shader is often paired an outline shader.

<img src="assets/toon-shading-example.png" width="640" height="360">
<i>Toon shading in Houdini.</i>

So for toon shading we want to use our own shading model instead of the default gradient-based one. We will make the edge from lit to unlit harder and for the highlights we will use the popular Blinn-Phong reflection model.

<h1>Blinn-Phong Shading Model</h1>
The Blinn-Phong shading model is a reflection model widely used in 3D graphics. I won't go into extreme detail but basically the model works like this.

<img src="assets/blinn-phong.png">
<i>Normalized vectors in the Blinn-Phong model.</i>

In classic Phong shading, the dot product of R and V is calculated. V is the vector from the surface to the player and R is the vector that represents a reflected light beam.

In the Blinn-Phong model, an extra vector H is calculated which is called the 'halfway-vector'. It is called that way because it lies halfway between the vectors L and V where L is the vector that represents a light beam. This halfway vector is calculated as follows.

<img src="assets/halfway-vector.png">

What we do in this formula is we take the sum of the vectors V and L and we normalize the result to a
unit vector by dividing the result by its length.

<div>For more useful vector algebra check <a href="../vector-algebra/index.html" target="_blank" style="color:blue">this page</a>.
</div>

Now that we calculated this extra vector H, we no longer need to calculate the dot product of R and V, but instead, we can calculate the dot product of N and H. N is the surface normal vector. This is good because this method is more performance-efficient when the camera and light are far away from the surface which if often the case. When camera (V) and light (L) are far away from eachother, their halfway vector becomes very stable since the vectors V and L are converging. Because this vector H becomes very stable, we don't have to calculate it often.

Now that we have a shading model to work with, let's get started!

<h1>Step 1: Custom Lighting Node</h1><a name="tutorial-shortcut"></a>So, as explained in the sections above we will need several vectors. Specifically, we need the vector L (light direction), the vector N (surface normal) and the vector V (view direction). V and N are easily accessible in shader graph, but the light direction vector L is not. Right now there is no node in shader graph that supplies us with lighting data from the scene.

So what do we do?... Custom nodes!

Create a new custom function node. We will define 3 outputs. Direction, Color and Attenuation. Direction and Color are pretty self-explanatory. Attenuation is "the gradual loss of flux intensity through a medium". In more human language this is basically how much the intensity of the light weakens when you go further from the source. 

<img src="assets/custom-function-node.png">

Our custom node refers to a file called <i>MainLight.hlsl</i> with a function named <i>GetLightingInformation</i>. You can create this file and put it wherever you want. You can also name it however you want, choose the extension you want and choose the function name you want.

Create the file, put it in your unity project and refer to it in the node. Open the file and put the following code in it. (Only this function, no other code!) 

You can also get the code here <a href="https://pastebin.com/cP42bskG">https://pastebin.com/cP42bskG</a>

<img src="assets/function-code.png" width="653" height="220">

We don't to anything magical here. We create the function with its outputs, create a light and access its variables. I also converted the custom function node to a subgraph name 'Main Light'.

<img src="assets/subgraph.png">


<p1 style="color:#FF2222"><b>Important:</b></p1> You will probably be getting an error message in your project about an unknown identifier. This is because shader graph doesn't <i>really</i> know anything about lighting information so it has no clue what to draw in the shader preview window. To fix this we need to do some <i>hacky stuff</i>. Read more <a href="../preview-lighting/index.html" target="_blank" style="color:blue">here</a>.

<h1>Step 2: Directional Lighting And Mid Color</h1>The first step of creating a toon shader is determining what parts of our surface will be lit/unlit. We can figure this out by comparing the direction of the light to the normal vector of the surface of our object. Here, 'comparing' means taking the dot product. When the light direction and the surface's normal vector are aligned, that means that the light is directly shining on the surface and thus that part of the surface is maximally lit. We use the following nodes.

<img src="assets/directional-lighting.png"><i>Nodes to calculate which parts of our shader will be lit/unlit.</i>

As mentioned, we calculate the dot product of the light direction and the surface normal vector. We then feed it into a smoothstep function to make the edge between lit and unlit harder. We could use a step function for a super hard line but the smoothstep creates a smooth transition zone between lit and unlit. We make the transition zone small enough to still get the desired 'hard' effect. The smoothstep node returns a smoothed value between 0 and 1 when the input value is between Edge1 and Edge2. For Edge1 we take 0 and for Edge2 we take a very small value so that the transition zone remains small. Finally we multiply the output by a color property that will represent our 'mid tone colors' and plug it into the color slot of our master node.

These nodes give us the following result.

<img src="assets/basic-shading.gif">
<i>Basic shading based on a directional light.</i>

<h1>Step 3: Shaded Color</h1>Right now the unlit parts of our objects are black. Of course if this is what you want, go for it! However I want to be able to color that part separately too.

We add these nodes.

<img src="assets/shaded-color.png">

We add a one minus node to access the unlit part of our object and multiply by a color. Finally we add the 2 generated colors (mid and shaded) together. Now we are able to make some cool two-tone shading effects.

<img src="assets/two-tone.gif" width="350" height="350">

<h1>Step 4: Light Color</h1>For now, our object's color is not affected by the color or intensity of the directional light. We add a few nodes to add a contribution of the directional light to the color of our object. We also add a 'Light Intensity' slider from 0 to 1 to limit the contribution from the directional light.

<img src="assets/light.png">

Now our object can be affected by the light color from the directional light.

<img src="assets/light-effect.gif" width="350" height="350">


<h1>Step 5: Highlight Color</h1>The last color-tone we want to add is of course highlights. These make the toon shader really look toonish! These highlights are like faked reflections and we can generate them by using our Blinn-Phong shading model. We implement this model as follows.

<img src="assets/phong-nodes.png">

As explained in the theory, we add the view direction and the light direction and normalize the result. Then we take the dot product from this halfway vector and the surface normal vector.

<img src="assets/reflections.png">

Next, we multiply the output of this dot product by <i><b>the output of the directional lighting group</b></i>. This will ensure that we only draw highlights on the lit side of the object. We also add a parameter 'Highlight Amount' to control the size of the highlight sections and we smooth the transition zone just like we did for our other color tones. Finally we multiply by a highlight color parameter and add the result at the very end of our nodes. Note that the highlight color will be added on top of the mid tone color.

<img src="assets/highlights.gif" width="350" height="350">

<h1>Step 6: Rim Effect</h1>It would be nice to add an outer glow to the object. You could think of this as an extra highlight edge. This is easily done with a fresnel node.

<img src="assets/rim.png"> 

We make fresnel effect a bit smoother again with a smoothstep node. The 'rim amount' property gets subtracted and added by 0.01 to form the 'edges' for the smoothstep node.

<img src="assets/rim-control.png">

Next, we add some nodes to control the rim effect a bit more so that it's only visible on the lit part of our object.

<img src="assets/rim-effect.gif" width="350" height="350">

<h1>What's Left?</h1>
You can add more things to this shader. Maybe a black outline would look nice? Or a <a href="https://connect.unity.com/p/zelda-inspired-toon-shading-in-shadergraph" target="_blank">brush stroke effect</a>? Go crazy!

<h1>Sources</h1><a href="https://en.wikipedia.org/wiki/Blinn%E2%80%93Phong_shading_model" target="_blank">https://en.wikipedia.org/wiki/Blinn%E2%80%93Phong_shading_model</a>
<a href="https://en.wikipedia.org/wiki/Attenuation" target="_blank">https://en.wikipedia.org/wiki/Attenuation</a>
<a href="https://roystan.net/articles/toon-shader.html " target="_blank">https://roystan.net/articles/toon-shader.html </a>
<a href="http://www.sidefx.com/docs/houdini/nodes/shop/tooncolorshader.html" target="_blank">http://www.sidefx.com/docs/houdini/nodes/shop/tooncolorshader.html</a>
<a href="https://connect.unity.com/p/zelda-inspired-toon-shading-in-shadergraph" target="_blank">https://connect.unity.com/p/zelda-inspired-toon-shading-in-shadergraph</a>

<hr>
<a href="http://www.twitter.com/alexanderameye" target="_blank">@alexanderameye</a>
<a href="mailto:alexanderameye@gmail.com">alexanderameye@gmail.com</a>

</body>

</html>